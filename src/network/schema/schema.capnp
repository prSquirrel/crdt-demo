@0x8a288399e900f2b9;  # unique file ID, generated by `capnp id`

struct Message {
  vclock @0 :VectorClock;
  union {
    unknown @1 :Void;
    operation @2 :OperationMessage;
    sync @3 :SyncMessage;
  }

  struct VectorClock {
    site @0 :Text;
    clockMap @1 :ClockMap;

    struct ClockMap {
      entries @0 :List(Entry);
      struct Entry {
        site @0 :Text;
        clock @1 :UInt32;
      }
    }
  }
}

struct OperationMessage {
  operation @0 :Operation;
}

struct SyncMessage {
  operations @0 :List(Operation);
  batchNumber @1 :UInt32;
  lastBatchNumber @2 :UInt32;
}

struct Operation {
  union {
    unknown @0 :Void;
    insert @1 :Insert;
    remove @2 :Remove;
  }

  struct Insert {
    value @0 :Text;
    timestamp @1 :Timestamp;
    happenedBefore @2 :List(Timestamp);
    referenceTimestamp @3 :Timestamp;
  }

  struct Remove {
    timestamp @0 :Timestamp;
  }

  struct Timestamp {
    site @0 :Text;
    clock @1 :UInt32;
  }
}
